# 分布式限流器

## 简介

本项目是一个基于本地限流的分布式限流器，适合粗粒度流量控制，不能做到完全精确。

---

## 原理

- 每个实例本地维护限流器（基于 `golang.org/x/time/rate`）。
- 全局限流目标（如 QPS）由所有实例按权重分摊。
- 节点信息（ID、权重）通过 HTTP API 由外部统一推送到所有实例。
- 每个实例根据最新节点列表和权重，动态调整本地限流速率。

---

## 设计

- **NodeManager**：管理节点列表和权重。
- **Limiter**：本地限流器，支持动态调整速率。
- **API**：暴露 HTTP 接口，支持外部更新节点。
- **main.go**：启动入口，初始化并启动服务。

---

## 限流策略

- 全局限流目标 QPS 由所有实例按权重分摊：
  - 每个实例速率 = QPS × (本实例权重 / 所有权重之和)
- 只要节点信息同步及时，限流效果接近全局一致，但不能做到完全精确。

---

## 适用场景

- 适合粗粒度流量控制，如 API 网关、服务集群等。
- 不适合对单个请求强一致、毫秒级精确限流的场景。

---

## 使用方式

### 1. 启动服务

```sh
go run main.go --id=inst1 --qps=1000 --weight=1 --port=8080
```

- `--id`：本实例唯一 ID
- `--qps`：全局 QPS 限流
- `--weight`：本实例权重
- `--port`：监听端口

### 2. 更新节点列表

通过 HTTP POST `/update_nodes`，传入所有节点的 ID 和权重：

```json
[
  {"id": "inst1", "weight": 1},
  {"id": "inst2", "weight": 2}
]
```

---

## 注意

- 适合粗粒度控制，不能完全精确。 